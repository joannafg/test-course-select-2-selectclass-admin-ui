import{_ as e}from"./index-DBV9O_Xv.js";import{b as a}from"./index-FaVgdj3V.js";import{d as s,L as l,p as o,r as t,A as r,c as n,w as d,f as i,J as p,a as u,h as c,C as w,t as m,o as h,M as v,an as f,ao as g,ap as y,x as b}from"./index-BAyZi_co.js";import{b as P}from"./captcha-noq_IUbv.js";import{d as _,e as x,u as j}from"./user-center-DOjaikc1.js";import{e as k}from"./encrypt-fe7GwHAY.js";import{_ as R}from"./GiForm-BWZRNfN-.js";import{u as V}from"./useResetReactive-NMdkdCz2.js";import{P as q,E as C}from"./regexp-DaVwsOyC.js";import"./index-DVDBkEOF.js";import"./index.vue_vue_type_script_setup_true_lang-Dekw0iDL.js";const z=b(s({__name:"VerifyModel",setup(s,{expose:b}){const{width:z}=a(),I=l(),F=o((()=>I.userInfo)),O=t(),T=o((()=>"modify"+("phone"===O.value?"phone":"email"===O.value?"email":"password"))),U=t(),B={form:{size:"large"},btns:{hide:!0}},[M,$]=V({phone:"",email:"",captcha:"",oldPassword:"",newPassword:"",rePassword:""}),A=r([{label:"phone",field:"phone",type:"input",rules:[{required:!0,message:"please enter the phone"},{match:q,message:"please enter the correct phone"}],hide:()=>"phone"!==O.value},{label:"email",field:"email",type:"input",rules:[{required:!0,message:"please enter the email"},{match:C,message:"please enter the correct email"}],hide:()=>"email"!==O.value},{label:"captcha",field:"captcha",type:"input",rules:[{required:!0,message:"please enter the captcha"}],hide:()=>!["phone","email"].includes(O.value)},{label:"old password",field:"oldPassword",type:"input-password",rules:[{required:!0,message:"please enter the old password"}],hide:()=>!F.value.pwdResetTime},{label:"new password",field:"newPassword",type:"input-password",rules:[{required:!0,message:"please enter the new password"},{validator:(e,a)=>{e===M.oldPassword?a("the new password cannot be the same as the current password"):a()}}],hide:()=>"password"!==O.value},{label:"confirm new password",field:"rePassword",type:"input-password",props:{placeholder:"please enter the new password again"},rules:[{required:!0,message:"please enter the new password again"},{validator:(e,a)=>{e!==M.newPassword?a("the two passwords are inconsistent"):a()}}],hide:()=>"password"!==O.value}]),E=t(),G=t("blockPuzzle"),J=t("pop"),L=t(!1),S=async()=>{var e,a;if(L.value)return;await(null==(a=null==(e=U.value)?void 0:e.formRef)?void 0:a.validateField("phone"===O.value?"phone":"email"))||E.value.show()},D=t(),H=t(60),K=t("get captcha"),N=t(!1),Q=()=>{window.clearInterval(D.value),H.value=60,K.value="get captcha",N.value=!1},W=()=>{var e,a;null==(a=null==(e=U.value)?void 0:e.formRef)||a.resetFields(),$(),Q()},X=async e=>{try{L.value=!0,K.value="sending...","phone"===O.value||"email"===O.value&&await P(M.email,e),L.value=!1,N.value=!0,K.value=`get captcha(${H.value-=1}s)`,v.success("only for demonstration, please cancel the relevant comments for actual use"),D.value=window.setInterval((()=>{H.value-=1,K.value=`get captcha(${H.value}s)`,H.value<=0&&Q()}),1e3)}catch(a){Q()}finally{L.value=!1}},Y=async()=>{var e,a;if(await(null==(a=null==(e=U.value)?void 0:e.formRef)?void 0:a.validate()))return!1;try{if("phone"===O.value)await _({phone:M.phone,captcha:M.captcha,oldPassword:k(M.oldPassword)}),v.success("modify successfully");else if("email"===O.value)await x({email:M.email,captcha:M.captcha,oldPassword:k(M.oldPassword)}),v.success("modify successfully");else if("password"===O.value){if(M.newPassword!==M.rePassword)return v.error("the two new passwords are inconsistent"),!1;if(M.newPassword===M.oldPassword)return v.error("the new password cannot be the same as the old password"),!1;await j({oldPassword:k(M.oldPassword)||"",newPassword:k(M.newPassword)||""})}return!0}catch(s){return!1}},Z=async()=>{"password"===O.value?f({title:"prompt",content:"password modified successfully! please save the new password and use the new password to log in again",maskClosable:!1,escToClose:!1,okText:"re-login",async onOk(){g.done();const e=l();await e.logoutCallBack(),await y.replace("/login")}}):await I.getInfo()},ee=t(!1);return b({open:e=>{O.value=e,ee.value=!0}}),(a,s)=>{const l=u("a-input"),o=u("a-button"),t=e,r=u("a-modal");return h(),n(r,{visible:i(ee),"onUpdate:visible":s[2]||(s[2]=e=>p(ee)?ee.value=e:null),title:i(T),"mask-closable":!1,"esc-to-close":!1,width:i(z)>=600?600:"100%",draggable:"",onBeforeOk:Y,onOk:Z,onClose:W},{default:d((()=>[c(i(R),{ref_key:"formRef",ref:U,modelValue:i(M),"onUpdate:modelValue":s[1]||(s[1]=e=>p(M)?M.value=e:null),options:B,columns:i(A)},{captcha:d((()=>[c(l,{modelValue:i(M).captcha,"onUpdate:modelValue":s[0]||(s[0]=e=>i(M).captcha=e),placeholder:"please enter the captcha","max-length":6,"allow-clear":"",style:{flex:"1 1"}},null,8,["modelValue"]),c(o,{class:"captcha-btn",loading:i(L),disabled:i(N),size:"large",onClick:S},{default:d((()=>[w(m(i(K)),1)])),_:1},8,["loading","disabled"])])),_:1},8,["modelValue","columns"]),c(t,{ref_key:"VerifyRef",ref:E,"captcha-type":i(G),mode:i(J),"img-size":{width:"330px",height:"155px"},onSuccess:X},null,8,["captcha-type","mode"])])),_:1},8,["visible","title","width"])}}}),[["__scopeId","data-v-d0a99307"]]);export{z as default};
